<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
    <title>Navidad y Amor</title>
    <style>
        /* Estilos originales aquí */
    </style>
</head>
<body>
    <h1 class="message">🎄 Día 16: Navidad de las ratas ❤️</h1>
    <h2 class="message">Ayuda a la ratita a recolectar corazones para su novia 🐭❤️🐭</h2>
    <button id="startGame">Iniciar Juego</button>
    <button id="resetGame" style="display:none;">Reiniciar Juego</button>
    <canvas id="gameCanvas" width="800" height="400" style="display:none;"></canvas>
    <div class="joystick-container" id="joystickContainer" style="display:none;">
        <div class="joystick" id="joystick"></div>
    </div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startGame');
        const resetButton = document.getElementById('resetGame');
        const joystickContainer = document.getElementById('joystickContainer');
        const joystick = document.getElementById('joystick');

        const initialRatState = { x: 50, y: 200, width: 50, height: 50, speed: 5 };
        let rat = { ...initialRatState };
        let hearts = [];
        let powers = [];
        let score = 0;
        let highScore = 0;
        let gameInterval;
        let isGameOver = false;
        let multiplier = 1;
        const winScore = 20; // Puntaje para ganar

        const ratImage = new Image();
        ratImage.src = 'https://imgur.com/JKPSGw5.png';
        const heartImage = new Image();
        heartImage.src = 'https://imgur.com/e9Qi2mk.png';
        const powerImage = new Image();
        powerImage.src = 'https://imgur.com/1dL4RnG.png';

        function drawRat() {
            ctx.drawImage(ratImage, rat.x, rat.y, rat.width, rat.height);
        }

        function drawItems(items, image) {
            items.forEach(item => {
                ctx.drawImage(image, item.x, item.y, 30, 30);
            });
        }

        function updateItems(items, speed) {
            items.forEach(item => {
                item.x -= speed;
            });
            return items.filter(item => item.x > -30);
        }

        function generateHeart() {
            hearts.push({ x: canvas.width, y: Math.random() * (canvas.height - 30) });
        }

        function generatePower() {
            if (Math.random() < 0.5) {
                powers.push({ x: canvas.width, y: Math.random() * (canvas.height - 30) });
            }
        }

        function checkCollision(items, callback) {
            items.forEach((item, index) => {
                if (
                    rat.x < item.x + 30 &&
                    rat.x + rat.width > item.x &&
                    rat.y < item.y + 30 &&
                    rat.y + rat.height > item.y
                ) {
                    items.splice(index, 1);
                    callback();
                }
            });
        }

        function endGame(win = false) {
            isGameOver = true;
            clearInterval(gameInterval);
            ctx.font = '50px Arial';
            ctx.fillStyle = win ? 'green' : 'red';
            ctx.fillText(win ? "¡Ganaste!" : "Game Over", canvas.width / 2 - 120, canvas.height / 2);
            resetButton.style.display = 'block';
            highScore = Math.max(highScore, score);
        }

        function gameLoop() {
            if (isGameOver) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            drawRat();
            drawItems(hearts, heartImage);
            drawItems(powers, powerImage);

            let heartSpeed = Math.min(1.5 + score / 15, 5); // Velocidad creciente con límite
            hearts = updateItems(hearts, heartSpeed);
            powers = updateItems(powers, 2);

            checkCollision(hearts, () => {
                score += 1 * multiplier;
                if (score >= winScore) endGame(true);
            });
            checkCollision(powers, () => {
                multiplier = 5;
                setTimeout(() => multiplier = 1, 5000); // Regresar multiplicador tras 5 segundos
            });

            if (hearts.some(heart => heart.x < 0)) endGame();

            ctx.font = '20px Arial';
            ctx.fillStyle = 'red';
            ctx.fillText(`Puntaje: ${score}`, 10, 30);
            ctx.fillText(`Mejor Puntaje: ${highScore}`, 10, 60);
        }

        function startGame() {
            startButton.style.display = 'none';
            resetButton.style.display = 'none';
            canvas.style.display = 'block';
            joystickContainer.style.display = 'flex';
            score = 0;
            multiplier = 1;
            isGameOver = false;

            rat = { ...initialRatState };
            gameInterval = setInterval(gameLoop, 1000 / 60);
            setInterval(generateHeart, 3000); // Menor frecuencia para corazones
            setInterval(generatePower, 8000); // Frecuencia ajustada de poderes

            initializeJoystick();
        }

        function resetGame() {
            hearts = [];
            powers = [];
            rat = { ...initialRatState };
            startGame();
        }

        function initializeJoystick() {
            joystick.addEventListener('touchstart', handleJoystickStart);
            joystick.addEventListener('touchmove', handleJoystickMove);
            joystick.addEventListener('touchend', handleJoystickEnd);

            function handleJoystickStart(e) {
                e.preventDefault();
            }

            function handleJoystickMove(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = joystickContainer.getBoundingClientRect();
                const offsetX = touch.clientX - rect.left - rect.width / 2;
                const offsetY = touch.clientY - rect.top - rect.height / 2;

                if (Math.abs(offsetX) > Math.abs(offsetY)) {
                    if (offsetX > 40) moveRat('right');
                    else if (offsetX < -40) moveRat('left');
                } else {
                    if (offsetY > 40) moveRat('down');
                    else if (offsetY < -40) moveRat('up');
                }
            }

            function handleJoystickEnd() {}
        }

        function moveRat(direction) {
            if (direction === 'up' && rat.y > 0) rat.y -= rat.speed;
            if (direction === 'down' && rat.y < canvas.height - rat.height) rat.y += rat.speed;
            if (direction === 'left' && rat.x > 0) rat.x -= rat.speed;
            if (direction === 'right' && rat.x < canvas.width - rat.width) rat.x += rat.speed;
        }

        startButton.addEventListener('click', startGame);
        resetButton.addEventListener('click', resetGame);
    </script>
</body>
</html>
